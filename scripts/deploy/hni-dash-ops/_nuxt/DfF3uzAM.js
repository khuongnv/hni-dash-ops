import{l as ye,d as v,m as W,ae as he,A as d,C as t,N as a,Q as G,D as n,_ as h,al as Y,O as f,Z as K,$ as T,F as R,ah as X,P as o,B as u,u as C,af as we,V as ee,ag as le,E as O,ai as ke,aj as Ce,ak as De}from"./CXrpKCn2.js";import{u as $e}from"./BcSDHcqX.js";import{_ as x}from"./qZElNH4Q.js";import{_ as Ne,a as Te,b as Ve,c as Ee}from"./HuV0b2Xd.js";import{_ as Me}from"./CenQ87kS.js";import{_ as Se,a as je,b as z,c as g,d as Pe,e as m}from"./DEZtr9RY.js";import{_ as te}from"./BRkL9H2T.js";import{_ as D}from"./CchPNN15.js";import{_ as Fe}from"./vaddv-uB.js";import"./BvMX9gl2.js";import"./wptq1C8v.js";import"#entry";import"./BEHD0UYf.js";import"./DrkHBoYJ.js";const Ue={class:"h-full flex flex-col space-y-4"},ze={class:"flex items-center justify-between"},Be={class:"flex items-center gap-3"},Le={class:"flex items-center gap-2"},Ae=["value"],qe={key:0,class:"text-blue-600"},Qe={class:"rounded-md border"},He={class:"flex items-center justify-center gap-2"},Ge={class:"flex items-center gap-2"},Ke={class:"flex items-center"},Re={key:0,class:"w-3 h-3 flex items-center justify-center"},Xe={key:1,class:"w-3 h-3 flex items-center justify-center"},Oe=["onClick","title"],Ze={key:1,class:"w-4 h-4"},Ie={class:"font-medium text-foreground"},Je={key:0,class:"text-sm text-muted-foreground"},We={key:1,class:"text-sm text-muted-foreground"},Ye={key:0,class:"text-sm"},el={key:1,class:"text-sm text-muted-foreground"},ll={key:0,class:"text-sm text-muted-foreground max-w-xs truncate"},tl={key:1,class:"text-sm text-muted-foreground"},sl={class:"flex items-center gap-1"},nl={class:"text-lg font-semibold mb-4"},al=["value"],ol={class:"flex gap-3 pt-4"},rl={class:"text-gray-600 mb-6"},il={class:"flex gap-3"},Cl=ye({__name:"departments",setup(ul){const{getDepartments:se,createDepartment:ne,updateDepartment:ae,deleteDepartment:oe,getParentDepartments:Z}=$e(),_=v([]),$=v(!1),y=v(""),V=v("all"),E=v(new Set),M=v(!1),B=v(!1),w=v(!1),S=v(!1),j=v(!1),N=v(null),r=v({id:null,code:"",name:"",parent_id:null,map_id:null,level:1,note:""}),I=s=>_.value.some(e=>e.parent_id===s),re=s=>{E.value.has(s)?E.value.delete(s):E.value.add(s)},P=s=>E.value.has(s),L=s=>{if(!s.parent_id)return!1;const e=_.value.find(l=>l.id===s.parent_id);return e?P(e.id)?!0:L(e):!1},ie=s=>{const e=[],l=new Set,c=s.filter(i=>i.level===1).sort((i,k)=>i.id-k.id),b=i=>{l.has(i.id)||L(i)||(e.push(i),l.add(i.id),P(i.id)||s.filter(p=>p.parent_id===i.id).sort((p,U)=>p.id-U.id).forEach(p=>b(p)))};return c.forEach(i=>b(i)),s.forEach(i=>{!l.has(i.id)&&!L(i)&&e.push(i)}),e},A=s=>s.normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/đ/g,"d").replace(/Đ/g,"D"),ue=s=>{const e=[];let l=s.parent_id;for(;l;){const c=_.value.find(b=>b.id===l);if(c)e.unshift(c),l=c.parent_id;else break}return e},q=W(()=>{let s=_.value;if(y.value&&y.value.trim()){const e=y.value.toLowerCase().trim(),l=A(e),c=s.filter(i=>{const k=i.name.toLowerCase(),p=A(k),U=i.code.toLowerCase(),xe=A(U);return k.includes(e)||p.includes(l)||U.includes(e)||xe.includes(l)}),b=new Set;c.forEach(i=>{b.add(i.id),ue(i).forEach(p=>b.add(p.id))}),s=s.filter(i=>b.has(i.id))}return V.value==="root"?s=s.filter(e=>!e.parent_id):V.value==="child"&&(s=s.filter(e=>e.parent_id)),ie(s)}),de=W(()=>w.value?Z(_.value,r.value.id):Z(_.value)),F=async()=>{$.value=!0;try{_.value=await se()}catch(s){console.error("Error loading departments:",s)}finally{$.value=!1}},fe=()=>{},ce=s=>{const e=_.value.find(l=>l.id===s);return e?`${e.name} (${e.code})`:"Không xác định"},ve=s=>new Date(s).toLocaleDateString("vi-VN"),J=()=>{r.value={id:null,code:"",name:"",parent_id:null,map_id:null,level:1,note:""}},me=()=>{w.value=!1,J(),M.value=!0},pe=s=>{w.value=!0,r.value={id:s.id,code:s.code,name:s.name,parent_id:s.parent_id,map_id:s.map_id,level:s.level,note:s.note||""},M.value=!0},Q=()=>{M.value=!1,J()},ge=async()=>{if(!r.value.code.trim()||!r.value.name.trim()){alert("Vui lòng nhập đầy đủ thông tin bắt buộc");return}S.value=!0;try{w.value?await ae(r.value.id,{code:r.value.code,name:r.value.name,parent_id:r.value.parent_id,map_id:r.value.map_id,level:r.value.level,note:r.value.note||null}):await ne({code:r.value.code,name:r.value.name,parent_id:r.value.parent_id,map_id:r.value.map_id,level:r.value.level,note:r.value.note||null}),await F(),Q()}catch(s){console.error("Error submitting form:",s)}finally{S.value=!1}},_e=s=>{N.value=s,B.value=!0},H=()=>{B.value=!1,N.value=null},be=async()=>{if(N.value){j.value=!0;try{await oe(N.value.id),await F(),H()}catch(s){console.error("Error deleting department:",s)}finally{j.value=!1}}};return he(()=>{F()}),(s,e)=>(u(),d("div",Ue,[t(Fe,{title:"Quản lý Đơn vị",description:"Quản lý cấu trúc tổ chức và đơn vị"}),a("div",ze,[a("div",Be,[t(x,{onClick:me,class:"flex items-center gap-2"},{default:n(()=>[t(C(we),{class:"w-4 h-4"}),e[10]||(e[10]=o(" Thêm đơn vị mới ",-1))]),_:1}),t(x,{variant:"outline",onClick:F,disabled:$.value},{default:n(()=>[t(C(ee),{class:le(["w-4 h-4",{"animate-spin":$.value}])},null,8,["class"]),e[11]||(e[11]=o(" Làm mới ",-1))]),_:1},8,["disabled"])]),a("div",Le,[h(a("select",{"onUpdate:modelValue":e[0]||(e[0]=l=>V.value=l),onChange:fe,class:"w-40 h-10 px-3 py-2 text-sm border border-input bg-background rounded-md focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2"},[...e[12]||(e[12]=[a("option",{value:"all"},"Tất cả",-1),a("option",{value:"root"},"Đơn vị gốc",-1),a("option",{value:"child"},"Đơn vị con",-1)])],544),[[Y,V.value]]),a("input",{value:y.value,onInput:e[1]||(e[1]=l=>y.value=l.target.value),placeholder:"Tìm kiếm đơn vị...",class:"w-64 h-10 px-3 py-2 text-sm border border-input bg-background rounded-md focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2"},null,40,Ae)])]),t(Ne,{class:"-mt-2"},{default:n(()=>[t(Te,null,{default:n(()=>[t(Ve,null,{default:n(()=>[...e[13]||(e[13]=[o("Danh sách Đơn vị",-1)])]),_:1}),t(Me,null,{default:n(()=>[o(" Tổng cộng "+f(q.value.length)+" đơn vị ",1),y.value?(u(),d("span",qe,' (Tìm kiếm: "'+f(y.value)+'") ',1)):G("",!0)]),_:1})]),_:1}),t(Ee,null,{default:n(()=>[a("div",Qe,[t(Se,null,{default:n(()=>[t(je,null,{default:n(()=>[t(z,null,{default:n(()=>[t(g,{class:"w-12"},{default:n(()=>[...e[14]||(e[14]=[o("#",-1)])]),_:1}),t(g,null,{default:n(()=>[...e[15]||(e[15]=[o("Code",-1)])]),_:1}),t(g,null,{default:n(()=>[...e[16]||(e[16]=[o("Tên đơn vị",-1)])]),_:1}),t(g,null,{default:n(()=>[...e[17]||(e[17]=[o("Đơn vị cha",-1)])]),_:1}),t(g,null,{default:n(()=>[...e[18]||(e[18]=[o("Cấp",-1)])]),_:1}),t(g,null,{default:n(()=>[...e[19]||(e[19]=[o("Đơn vị",-1)])]),_:1}),t(g,null,{default:n(()=>[...e[20]||(e[20]=[o("Ghi chú",-1)])]),_:1}),t(g,null,{default:n(()=>[...e[21]||(e[21]=[o("Ngày tạo",-1)])]),_:1}),t(g,{class:"w-32"},{default:n(()=>[...e[22]||(e[22]=[o("Thao tác",-1)])]),_:1})]),_:1})]),_:1}),t(Pe,null,{default:n(()=>[$.value?(u(),O(z,{key:0},{default:n(()=>[t(m,{colspan:"9",class:"text-center py-8"},{default:n(()=>[a("div",He,[t(C(ee),{class:"w-4 h-4 animate-spin"}),e[23]||(e[23]=o(" Đang tải... ",-1))])]),_:1})]),_:1})):q.value.length===0?(u(),O(z,{key:1},{default:n(()=>[t(m,{colspan:"9",class:"text-center py-8 text-muted-foreground"},{default:n(()=>[...e[24]||(e[24]=[o(" Không có đơn vị nào ",-1)])]),_:1})]),_:1})):(u(!0),d(R,{key:2},X(q.value,l=>(u(),O(z,{key:l.id,class:"table-row-fixed"},{default:n(()=>[t(m,{class:"font-medium align-middle"},{default:n(()=>[o(f(l.id),1)]),_:2},1024),t(m,{class:"align-middle"},{default:n(()=>[t(te,{variant:"outline"},{default:n(()=>[o(f(l.code),1)]),_:2},1024)]),_:2},1024),t(m,{class:"align-middle"},{default:n(()=>[a("div",Ge,[a("div",Ke,[(u(!0),d(R,null,X(l.level-1,c=>(u(),d("div",{key:c,class:"w-4 h-4 flex items-center justify-center"},[c===l.level-1?(u(),d("div",Re,[...e[25]||(e[25]=[a("div",{class:"w-4 h-4 border-l-2 border-b-2 border-muted-foreground/60 rounded-bl-sm"},null,-1)])])):(u(),d("div",Xe,[...e[26]||(e[26]=[a("div",{class:"w-px h-3 bg-border"},null,-1)])]))]))),128))]),I(l.id)?(u(),d("button",{key:0,onClick:c=>re(l.id),class:"flex items-center justify-center w-4 h-4 rounded hover:bg-muted transition-colors cursor-pointer",title:P(l.id)?"Mở rộng":"Thu gọn"},[t(C(ke),{class:le(["w-3 h-3 transition-transform duration-200 text-muted-foreground",P(l.id)?"rotate-0":"rotate-90"])},null,8,["class"])],8,Oe)):(u(),d("div",Ze)),a("div",Ie,f(l.name),1)])]),_:2},1024),t(m,{class:"align-middle"},{default:n(()=>[l.parent_id?(u(),d("span",Je,f(ce(l.parent_id)),1)):(u(),d("span",We,"Đơn vị gốc"))]),_:2},1024),t(m,{class:"align-middle"},{default:n(()=>[t(te,{variant:"outline",class:"text-xs"},{default:n(()=>[o(" Cấp "+f(l.level),1)]),_:2},1024)]),_:2},1024),t(m,{class:"align-middle"},{default:n(()=>[l.map_id?(u(),d("span",Ye,f(l.map_id),1)):(u(),d("span",el,"-"))]),_:2},1024),t(m,{class:"align-middle"},{default:n(()=>[l.note?(u(),d("span",ll,f(l.note),1)):(u(),d("span",tl,"-"))]),_:2},1024),t(m,{class:"text-sm text-muted-foreground"},{default:n(()=>[o(f(ve(l.created_at)),1)]),_:2},1024),t(m,null,{default:n(()=>[a("div",sl,[t(x,{variant:"ghost",size:"sm",onClick:c=>pe(l)},{default:n(()=>[t(C(Ce),{class:"h-4 w-4"})]),_:1},8,["onClick"]),t(x,{variant:"ghost",size:"sm",onClick:c=>_e(l),disabled:I(l.id),class:"text-destructive hover:text-destructive"},{default:n(()=>[t(C(De),{class:"h-4 w-4"})]),_:1},8,["onClick","disabled"])])]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1})])]),_:1})]),_:1}),M.value?(u(),d("div",{key:0,class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",onClick:Q},[a("div",{class:"bg-white rounded-lg p-6 w-full max-w-md mx-4",onClick:e[8]||(e[8]=K(()=>{},["stop"]))},[a("h3",nl,f(w.value?"Sửa đơn vị":"Thêm đơn vị mới"),1),a("form",{onSubmit:K(ge,["prevent"]),class:"space-y-4"},[a("div",null,[t(D,{for:"code"},{default:n(()=>[...e[27]||(e[27]=[o("Code *",-1)])]),_:1}),h(a("input",{id:"code","onUpdate:modelValue":e[2]||(e[2]=l=>r.value.code=l),type:"text",required:"",class:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"Nhập code đơn vị"},null,512),[[T,r.value.code]])]),a("div",null,[t(D,{for:"name"},{default:n(()=>[...e[28]||(e[28]=[o("Tên đơn vị *",-1)])]),_:1}),h(a("input",{id:"name","onUpdate:modelValue":e[3]||(e[3]=l=>r.value.name=l),type:"text",required:"",class:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"Nhập tên đơn vị"},null,512),[[T,r.value.name]])]),a("div",null,[t(D,{for:"parent_id"},{default:n(()=>[...e[29]||(e[29]=[o("Đơn vị cha",-1)])]),_:1}),h(a("select",{id:"parent_id","onUpdate:modelValue":e[4]||(e[4]=l=>r.value.parent_id=l),class:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"},[e[30]||(e[30]=a("option",{value:""},"Chọn đơn vị cha (tùy chọn)",-1)),(u(!0),d(R,null,X(de.value,l=>(u(),d("option",{key:l.id,value:l.id},f(l.name)+" ("+f(l.code)+") ",9,al))),128))],512),[[Y,r.value.parent_id]])]),a("div",null,[t(D,{for:"level"},{default:n(()=>[...e[31]||(e[31]=[o("Cấp tổ chức *",-1)])]),_:1}),h(a("input",{id:"level","onUpdate:modelValue":e[5]||(e[5]=l=>r.value.level=l),type:"number",min:"1",max:"10",required:"",class:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"Nhập cấp tổ chức (1-10)"},null,512),[[T,r.value.level,void 0,{number:!0}]])]),a("div",null,[t(D,{for:"map_id"},{default:n(()=>[...e[32]||(e[32]=[o("Đơn vị",-1)])]),_:1}),h(a("input",{id:"map_id","onUpdate:modelValue":e[6]||(e[6]=l=>r.value.map_id=l),type:"number",class:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"Nhập ID đơn vị (tùy chọn)"},null,512),[[T,r.value.map_id,void 0,{number:!0}]])]),a("div",null,[t(D,{for:"note"},{default:n(()=>[...e[33]||(e[33]=[o("Ghi chú",-1)])]),_:1}),h(a("textarea",{id:"note","onUpdate:modelValue":e[7]||(e[7]=l=>r.value.note=l),rows:"3",class:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"Nhập ghi chú (tùy chọn)"},null,512),[[T,r.value.note]])]),a("div",ol,[t(x,{type:"button",variant:"outline",onClick:Q,class:"flex-1"},{default:n(()=>[...e[34]||(e[34]=[o(" Hủy ",-1)])]),_:1}),t(x,{type:"submit",disabled:S.value,class:"flex-1"},{default:n(()=>[o(f(S.value?"Đang xử lý...":w.value?"Cập nhật":"Tạo mới"),1)]),_:1},8,["disabled"])])],32)])])):G("",!0),B.value?(u(),d("div",{key:1,class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",onClick:H},[a("div",{class:"bg-white rounded-lg p-6 w-full max-w-md mx-4",onClick:e[9]||(e[9]=K(()=>{},["stop"]))},[e[40]||(e[40]=a("h3",{class:"text-lg font-semibold mb-4 text-red-600"},"Xác nhận xóa",-1)),a("p",rl,[e[35]||(e[35]=o(" Bạn có chắc chắn muốn xóa đơn vị ",-1)),a("strong",null,'"'+f(N.value?.name)+'"',1),e[36]||(e[36]=o("? ",-1)),e[37]||(e[37]=a("br",null,null,-1)),e[38]||(e[38]=a("span",{class:"text-sm text-red-500"},"Hành động này không thể hoàn tác.",-1))]),a("div",il,[t(x,{variant:"outline",onClick:H,class:"flex-1"},{default:n(()=>[...e[39]||(e[39]=[o(" Hủy ",-1)])]),_:1}),t(x,{variant:"destructive",onClick:be,disabled:j.value,class:"flex-1"},{default:n(()=>[o(f(j.value?"Đang xóa...":"Xóa"),1)]),_:1},8,["disabled"])])])])):G("",!0)]))}});export{Cl as default};
